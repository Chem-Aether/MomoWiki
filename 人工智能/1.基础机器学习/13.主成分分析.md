# PCA

## 样本矩阵

设一个随机变量有$p$个维度，那么第$i$个样本$a_i$可以用$p$维向量来描述：

$$
\boldsymbol{r}_n = [a_1,a_2,\cdots,a_p]
$$

样本集合有$n$个样本，每个维度的样本构成一个列向量$c$：
$$
\boldsymbol{c}_p = 
\begin{bmatrix}
    a_1    \\
    a_2    \\
    \vdots \\
    a_n
\end{bmatrix}
$$

那么就形成了$n \times p$的样本矩阵：
$$
A = 
\begin{bmatrix}
\boldsymbol{r}_{1} \\
\boldsymbol{r}_{2} \\
\vdots \\
\boldsymbol{r}_{n} \\
\end{bmatrix} = 
\begin{bmatrix}
 a_{11} & a_{12} & \ldots & a_{1p}\\
 a_{21} & a_{22} & \ldots & a_{2p}\\
 \vdots & \vdots & \ddots & \vdots\\
 a_{n1} & a_{n2} & \ldots & a_{np}\\
\end{bmatrix} = 
[\boldsymbol{c}_1,\boldsymbol{c}_2,\cdots,\boldsymbol{c}_p]
$$

对每一列求均值，第$p$列的均值$\bar{a}_p$为：
$$
\bar{a}_p = \sum_{i=1}^n a_{i,p}
$$

进行样本中心化，每一列的值减去该列的平均值，得到新矩阵：
$$
A = [\boldsymbol{c}_1-\bar{a}_1,\boldsymbol{c}_2-\bar{a}_2,\cdots ,\boldsymbol{c}_p-\bar{a}_p]
$$

## 协方差矩阵

协方差计算公式为：

$$
\text{Cov}(X,Y) = \frac{1}{n-1} \sum_{i=1}^n (X_i-\bar{X})(Y_i-\bar{Y})
$$



对于$p$维变量的协方差矩阵是分别计算每个维度之间的协方差：

$$
C = 
\begin{bmatrix}
    \text{Cov}(\boldsymbol{c}_1,\boldsymbol{c}_1) & \text{Cov}(\boldsymbol{c}_1,\boldsymbol{c}_2) & \cdots & \text{Cov}(\boldsymbol{c}_1,\boldsymbol{c}_p) \\ 
    \text{Cov}(\boldsymbol{c}_2,\boldsymbol{c}_1) & \text{Cov}(\boldsymbol{c}_2,\boldsymbol{c}_2) & \cdots & \text{Cov}(\boldsymbol{c}_2,\boldsymbol{c}_p) \\
    \vdots       & \vdots       & \ddots & \vdots                            \\
    \text{Cov}(\boldsymbol{c}_p,\boldsymbol{c}_1) & \text{Cov}(\boldsymbol{c}_p,\boldsymbol{c}_2) & \cdots & \text{Cov}(\boldsymbol{c}_p,\boldsymbol{c}_p)
\end{bmatrix}
$$
协方差矩阵的每个值$C_{i,j}$表示第$i$和第$j$个维度的协方差，而对角线的值表示方差。

把协方差公式展开后，提出公共的$\frac{1}{n-1}$项，得到：

$$
C= \frac{1}{n-1}
\begin{bmatrix}
    \sum_{i=1}^n a_{i,1} \cdot a_{i,1} & \sum_{i=1}^n a_{i,1} \cdot a_{i,2} & \cdots & \sum_{i=1}^n a_{i,1} \cdot a_{i,p} \\
    \sum_{i=1}^n a_{i,2} \cdot a_{i,1} & \sum_{i=1}^n a_{i,2} \cdot a_{i,2} & \cdots & \sum_{i=1}^n a_{i,2} \cdot a_{i,p} \\
    \vdots              & \vdots              & \ddots & \vdots              \\
    \sum_{i=1}^n a_{i,p} \cdot a_{i,1} & \sum_{i=1}^n a_{i,p} \cdot a_{i,2} & \cdots & \sum_{i=1}^n a_{i,p} \cdot a_{i,p} 
\end{bmatrix}
$$

上述矩阵中的每个值：
$$
\begin{align*}
\sum_{i=1}^n a_{i,p} \cdot a_{i,p} &= a_{1,p} \cdot a_{1,p} + a_{2,p} \cdot a_{2,p} + \cdots + a_{n,p} \cdot a_{n,p} \\
&= \begin{bmatrix}
a_{1,p} & a_{2,p} & \cdots & a_{n,p}
\end{bmatrix} \times
\begin{bmatrix}
    a_{1,p} \\
    a_{2,p} \\ 
    \vdots  \\ 
    a_{n,p}
\end{bmatrix} \\
&= \boldsymbol{c}_p^T \cdot \boldsymbol{c}_p
\end{align*}
$$

整个矩阵可以最终化简得到：

$$
\begin{align*}
    C &= 
        \begin{bmatrix}
            \boldsymbol{c}_1^T \cdot \boldsymbol{c}_1 & \boldsymbol{c}_1^T \cdot \boldsymbol{c}_2 & \cdots & \boldsymbol{c}_1^T \cdot \boldsymbol{c}_p    \\
            \boldsymbol{c}_2^T \cdot \boldsymbol{c}_1 & \boldsymbol{c}_2^T \cdot \boldsymbol{c}_2 & \cdots & \boldsymbol{c}_2^T \cdot \boldsymbol{c}_p    \\
            \vdots  & \vdots & \ddots & \vdots \\
            \boldsymbol{c}_p^T \cdot \boldsymbol{c}_1 & \boldsymbol{c}_p^T \cdot \boldsymbol{c}_2 & \cdots & \boldsymbol{c}_p^T \cdot \boldsymbol{c}_p
        \end{bmatrix} \\
      &= \begin{bmatrix}
            \boldsymbol{c}_1 \\ \boldsymbol{c}_2 \\ \vdots \\ \boldsymbol{c}_p
        \end{bmatrix} \times 
        \begin{bmatrix}
            \boldsymbol{c}_1 & \boldsymbol{c}_2 & \cdots & \boldsymbol{c}_p
        \end{bmatrix} \\
      &= \frac{1}{n-1} A^TA
\end{align*}
$$

## 主成分1

求第一主成分PC1的问题可转化为计算每个样本向量在$\vec{v}$上投影点的方差最大问题：

$$
max \quad s^2 = \frac{1}{n-1} \sum_{i=1}^n S_i^2
$$

式子中的$S^2$是每个样本在$\vec{v}$向量上的投影值：

$$
S^2 = (\vec{a} \cdot \vec{v})^2
$$

$\vec{a} \cdot \vec{v}$得到一个标量，而行向量乘以列向量也得到标量（一维矩阵），$\vec{a} \cdot \vec{v} = \vec{v}^T \vec{a}_i = \vec{a}_i^T \vec{v}$，那么可以代换得到：

$$
\sum_{i=1}^n S_i^2 = \sum_{i=1}^n (\vec{a}_i \cdot \vec{v})^2 = \sum_{i=1}^n (\vec{v}^T \vec{a}_i)(\vec{a}_i^T \vec{v})
$$

这时公共项可以提出求和式：
$$
\sum_{i=1}^n (\vec{v}^T \vec{a}_i)(\vec{a}_i^T \vec{v}) = \vec{v}^T (\sum_{i=1}^n \vec{a}_i \vec{a}_i^T) \vec{v}
$$


$$
\sum_{i=1}^n \vec{a}_i \vec{a}_i^T = A^TA
$$

用$AA^T$代换1求和式：
$$
\vec{v}^T (\sum_{i=1}^n \vec{a}_i \vec{a}_i^T) \vec{v} = \vec{v}^T (A^TA) \vec{v}
$$

根据上文的推导，最终样本方差$s^2$就转化为下式：
$$
\quad s^2 = \frac{1}{n-1} \sum_{i=1}^n S_i^2 = \frac{1}{n-1} \vec{v}^T (A^TA) \vec{v} = \vec{v}^T C \vec{v}
$$

## 求极大值问题

最终将问题转变为已知条件下的最大值问题，可以利用拉格朗日乘数法求解：

$$
\begin{align*}
    max  & \quad  s^2 = \vec{v}^T C \vec{v} \\
    s.t. & \quad  \vec{v}\vec{v}^T = 1 
\end{align*}
$$

构造拉格朗日函数：
$$
F(\vec{v}) = \vec{v} \cdot C \cdot \vec{v}^T - \lambda(1-\vec{v} \cdot \vec{v}^T)
$$

对函数求偏导：
$$
\frac{\partial F}{\partial \vec{v}} = 2C\vec{v^T} - 2 \lambda \vec{v}^T =0
$$

最后就得到了：
$$
C \vec{v}^T = \lambda \vec{v}^T 
$$

这说明，$\vec{v}^T$是协方差矩阵$C$的特征向量，$\lambda$是对应的特征值，把上式带入目标函数，得到：
$$
\vec{v}^T C \vec{v} = \vec{v}^T (\lambda \vec{v}) = \lambda (\vec{v}^T \vec{v}) = \lambda
$$

最大化目标函数就等价于最大化特征值$\lambda$，求每个主成分就相当于对协方差矩阵$C$做特征值分解，选前$k$个特征值。